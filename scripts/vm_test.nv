-- 复杂嵌套示例：计算并显示结果
-- 测试 VM 的栈偏移局部变量功能

println "=== 嵌套作用域测试 ==="

-- 全局变量
total := 0

-- 第一层嵌套
if true then
    a := 10
    println "Level 1: a = "
    println a
    
    -- 第二层嵌套
    if a > 5 then
        b := 20
        c := a + b
        println "Level 2: a + b = "
        println c
        
        -- 第三层嵌套
        if c > 25 then
            d := 100
            result := a + b + c + d
            println "Level 3: a + b + c + d = "
            println result
            
            -- 第四层嵌套
            if result > 100 then
                println "Level 4: Result is greater than 100!"
                bonus := 50
                final := result + bonus
                println "Final value = "
                println final
            end
        end
    end
    
    -- 退出内层后，b, c, d 都被清理了
    -- 只剩 a
    println "Back to Level 1: a = "
    println a
    
    -- 在第一层声明新变量（复用 slot）
    x := 999
    println "New variable x = "
    println x
end

-- 测试条件为假的分支
println "=== 测试 else 分支 ==="
if false then
    println "This should not print"
else
    fallback := 42
    println "Else branch: fallback = "
    println fallback
end

-- 计算表达式
println "=== 表达式计算 ==="
expr_result := 2 + 3 * 4 - 1
println "2 + 3 * 4 - 1 = "
println expr_result

-- 比较运算
println "=== 比较运算 ==="
if 10 > 5 and 3 < 8 then
    println "10 > 5 AND 3 < 8 is true"
end

if 10 == 10 then
    println "10 == 10 is true"
end

if 5 ~= 3 then
    println "5 ~= 3 is true"
end

-- 嵌套计算
println "=== 嵌套计算 ==="
if true then
    outer := 100
    if true then
        inner := 200
        if true then
            deepest := 300
            sum := outer + inner + deepest
            println "outer + inner + deepest = "
            println sum
        end
    end
end

println "=== 测试完成 ==="
